---
title: "Structural Causal Model: Simple Simulation"
author: "Anas Mourahib"
date: "`r Sys.Date()`"
output: html_document
---

## Introduction

In this session, we simulate a simple structural causal model (SCM) using Gaussian noise.

The variables are generated according to:

- \(X_1\) is independent  
- \(X_2\) depends on \(X_1\)  
- \(X_3\) depends on \(X_1\)  
- \(X_4\) depends on both \(X_2\) and \(X_3\)

---

## Causal Graph

The associated directed acyclic graph (DAG) is:

Don't forget to installe the \emph{DiagrammeR} package
```{r, message=FALSE, warning=FALSE}
library(DiagrammeR)
grViz("
digraph scm {

  # Global node style
  node [
    shape = circle,
    style = filled,
    color = lightblue,
    fixedsize = true,
    width = 0.4,
    height = 0.4,
    fontsize = 10
  ]

  # Nodes
  X1; X2; X3; X4;

  # Edges (causal links)
  X1 -> X2;
  X1 -> X3;
  X2 -> X4;
  X3 -> X4;
}
")


```


## Data Simulation
We simulate a Gaussian linear structural causal model with respect to the DAG above.
```{r}
set.seed(7)

# Generate variables from a simple SCM
X1 = rnorm(100)
X2 = X1 + rnorm(100)
X3 = X1 + rnorm(100)
X4 = X2 + X3 + rnorm(100)

# Store the dataset in a data frame
dat <- data.frame(X1, X2, X3, X4)

# Display the first few observations
head(dat)
```

## Scatter Plot Matrix

To visualize the relationships between variables, we plot pairwise scatter plots

```{r}
pairs(dat,
      pch = 19,
      col = rgb(0, 0, 0, 0.5),
      main = expression("Scatter plots of " ~ X[i] ~ " vs " ~ X[j]))

```

## Interventions and causal links 
Let $a = 1$, and consider the intervention $do(X_1 = a)$. 

```{r}
set.seed(7)
a = 1
# Generate variables from a simple SCM
X1_i = a
X2_i = X1_i + rnorm(100)
X3_i = X1_i + rnorm(100)
X4_i = X2_i + X3_i + rnorm(100)

# Store the dataset in a data frame
dat_i <- data.frame(X1_i, X2_i, X3_i, X4_i)

# Display the first few observations
head(dat_i)
```

## Scatter Plot Matrix

To visualize the relationships between variables, we plot pairwise scatter plots

```{r}
pairs(dat_i,
      pch = 19,
      main = expression("Scatter plots of " ~ X[i] ~ " vs " ~ X[j]),
      panel = function(x, y, ...) {
        
        # If X1 is involved, color red
        if (all(x == dat$X1) || all(y == dat$X1)) {
          points(x, y, col = "red", pch = 19)
        } else {
          points(x, y, col = rgb(0, 0, 0, 0.5), pch = 19)
        }
      })


```

We want now to check if there's a causal link from $X_1$ to $X_2$. To do so, we need to compare the distribution $\mathbb{P}_{X_2}$ and 
$\mathbb{P}_{X_2}^{do(X_1 = a)}$. We can easily see that 
$$
\mathbb{P}_{X_2} = \mathcal{N}(0 , 1),
\qquad 
\mathbb{P}_{X_2}^{do(X_1 = a)}  =\mathcal{N}(1, 1).
$$
Therefore, $\mathbb{P}_{X_2} \neq \mathbb{P}_{X_2}^{do(X_1 = a)}$. Thus, there's a causal link from $X_1$ to $X_2$. We can also check that by ploting the empirical a kernel estimate of the density of each sample. 
##Gaussian kernel density estimate before and after intrvention
```{r}
# Compute kernel density estimates
dens_before <- density(X2)
dens_after  <- density(X2_i)

# Plot the first density
plot(dens_before,
     col = "blue",
     lwd = 2,
     main = "Density of X2 before and after intervention",
     xlab = "X2",
     ylab = "Density",
     ylim = c(0,0.5))

# Add the second density
lines(dens_after, col = "red", lwd = 2)

# Add a legend
legend("topright",
       legend = c("Before intervention", "After intervention"),
       col = c("blue","red"),
       lwd = 2)

```

---

# Conclusion

1. We have simulated from 4-dimensional Gaussian linear structural causal model

2. We performed a perfect intervention on one component of this structural causal model ($do(X_1 = a)$)

3. We studied the notion of causal link from one component to the other