---
title: "Limitations of additive noise models in the linear Gaussian case"
author: "Anas Mourahib"
date: "`r Sys.Date()`"
output: html_document
---



```{r setup, include=FALSE}
if(!require(dHSIC)) install.packages("dHSIC", repos = "https://cloud.r-project.org/")
```

############################################################



In this file, we illustrate the limitation of **Additive Noise Model (ANM)** for causal discovery in the linear Gaussian case. In this case, we lose the asymmetry between $X$ and $Y$ and ANM fails to detect the true causal structure  

We generate data according to the model

$$
Y = 0.5 \cdot X + N_Y,
$$

where:

- $X$ is the cause,

- $N_Y$ is an independent noise term.

- Both $X$ and $N_Y$ are Gaussian.

 
We then:

1. Fit linear regressions in the causal and anti-causal directions,

2. Compute residuals,

3. Test independence using the **Hilbertâ€“Schmidt Independence Criterion (HSIC)**.


############################################################
# DATA GENERATION
############################################################


We simulate data from the additive noise model

$$
Y = 0.5 \cdot X + N_Y,
$$

where both $X$ and $N_Y$ are independent, $X \sim \mathcal{N}(2 , 1)$ and $N_Y \sim \mathcal{N}(0 , 0.3^2)$.

```{r}
n= 1000
a = 2
X = rnorm(n , 2 , 1)
N = rnorm(n , 0 , 0.3)
Y = a * X + N 
```



# ----------------------------------------------------------

#  Causal direction X -> Y 

# ----------------------------------------------------------


We now regress Y on X, which corresponds to the true causal
direction.

If the ANM assumption is correct, the regression residuals
should be independent of X.

############################################################

# Fit linear regression Y ~ X

############################################################
```{r}
causal_model <- lm(Y ~ X)

# ----------------------------------------------------------

# Step 7: Extract residuals

# These residuals estimate the noise N_Y

# ----------------------------------------------------------

residual_causal <- residuals(causal_model)




```



If residuals are independent of X, we should not see
any systematic pattern.

```{r}
plot(
X,
residual_causal,
xlab = "X (Cause)",
ylab = "Residuals of regression Y on X",
main = "Causal Direction: Y ~ X",
pch = 16,
col = rgb(0, 0, 1, 0.5)
)





```


############################################################

# Independence test- Hilbert--Schmidt Independence Criterion

############################################################




To test whether two samples $U$ and $V$ are independent, you can use the **Hilbert--Schmidt Independence Criterion (HSIC)** test; Gretton, A., K. Fukumizu, C. H. Teo, L. Song, B. Scholkopf and A. J. Smola (2007). A kernel statistical test of independence.
This test considers the hypotheses
\[
H_0 : U \!\perp\!\!\!\perp V, \qquad
H_1 : U \not\!\perp\!\!\!\perp V.
\]

In **R**, the test can be performed using the **dHSIC** package as follows:


```{r}
library(dHSIC)

###Here, R uses automatically the permutation method and the Gaussian kernels for the HSIC test
dtes_causal = dhsic.test(X , residual_causal)
pvalue_causal = dtes_causal$p.value
cat(
  "This is the p-value for testing X independent of the residuals of Y on X:",
  pvalue_causal,
  ". Since this p-value is larger than 0.05, we keep the null hypothesis H_0 of independence."
)



```

# ----------------------------------------------------------

# Anti-causal direction Y -> X 

# ----------------------------------------------------------


Now we regress X on Y, corresponding to the anti-causal direction.

If everything is good, we expect to observe some patterns of dependence between the residuals and  $Y$



```{r}

# ----------------------------------------------------------

# Step 8: Fit linear regression X ~ Y (anti-causal)

# ----------------------------------------------------------

anticausal_model <- lm(X ~ Y)

# ----------------------------------------------------------

# Step 9: Extract residuals

# ----------------------------------------------------------

residual_anticausal <- residuals(anticausal_model)



```




```{r}
plot(
Y,
residual_anticausal,
xlab = "Y (Effect)",
ylab = "Residuals of regression X on Y",
main = "Anti-Causal Direction: X ~ Y",
pch = 16,
col = rgb(1, 0, 0, 0.5)
)





```


############################################################

# Independence test: Hilbert--Schmidt Independence Criterion

############################################################



```{r}
library(dHSIC)


dtes_anticausal = dhsic.test(Y , residual_anticausal)
pvalue_anticausal =dtes_anticausal$p.value
cat(
  "This is the p-value for testing Y independent of the residuals of X on Y:",
  pvalue_anticausal,
  ". Since this p-value is larger than 0.05, we reject the null hypothesis H_0 of independence."
)



```


############################################################

# Results

############################################################

For **linear Gaussian additive noise models**, the ANM approach fails to identify the true causal direction. 
In this setting, the joint distribution $(X, Y)$ is **bivariate Gaussian**, which implies that the model is symmetric with respect to $X$ and $Y$. 
As a consequence, the asymmetry exploited by additive noise models to infer causality disappears, and the causal direction cannot be distinguished from observational data alone.